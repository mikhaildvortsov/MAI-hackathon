// Определение отдела банка на основе содержания письма
const BANK_DEPARTMENTS = {
  "Отдел кредитования": [
    "кредит", "заявка на кредит", "кредитная карта", "автокредит",
    "потребительский кредит", "рефинансирование", "кредитование"
  ],
  "Отдел ипотечного кредитования": [
    "ипотека", "ипотечный кредит", "жилье", "квартира", "дом",
    "недвижимость", "ипотечная программа"
  ],
  "Отдел депозитов и вкладов": [
    "вклад", "депозит", "накопления", "сбережения", "процент по вкладу",
    "открытие вклада", "пополнение вклада"
  ],
  "Отдел карточных продуктов": [
    "карта", "дебетовая карта", "кредитная карта", "блокировка карты",
    "перевыпуск карты", "пин-код", "транзакция по карте", "платежная система"
  ],
  "Отдел корпоративного обслуживания": [
    "юридическое лицо", "корпоративный клиент", "бизнес-счет",
    "расчетно-кассовое обслуживание", "зарплатный проект", "ВЭД"
  ],
  "Отдел розничного обслуживания": [
    "физическое лицо", "частный клиент", "открытие счета", "перевод",
    "платеж", "консультация", "обслуживание"
  ],
  "Отдел инвестиционных продуктов": [
    "инвестиции", "акции", "облигации", "паевые фонды", "брокерский счет",
    "доверительное управление", "портфель"
  ],
  "Отдел валютных операций": [
    "валюта", "обмен валют", "валютный перевод", "курс валют",
    "валютный счет", "конвертация", "валютные операции"
  ],
  "Отдел безопасности": [
    "мошенничество", "безопасность", "блокировка", "подозрительная операция",
    "фишинг", "кража данных", "несанкционированный доступ", "защита"
  ],
  "Отдел по работе с проблемной задолженностью": [
    "просрочка", "задолженность", "долг", "коллекторы",
    "реструктуризация долга", "списание долга", "неплатежеспособность"
  ],
  "Отдел партнерств и развития бизнеса": [
    "партнерство", "сотрудничество", "партнерская программа",
    "B2B", "B2B2C", "интеграция", "API", "белый label"
  ],
  "Отдел IT и цифровых решений": [
    "техническая поддержка", "мобильное приложение", "сайт",
    "API", "интеграция", "технические вопросы", "баг", "ошибка системы"
  ],
  "Отдел претензий и жалоб": [
    "жалоба", "претензия", "недовольство", "возврат средств",
    "компенсация", "нарушение", "некачественное обслуживание"
  ],
  "Отдел юридических вопросов": [
    "юрист", "правовой", "суд", "договор", "закон", "регулирование",
    "нормативные акты", "соглашение"
  ],
  "Отдел риск-менеджмента": [
    "риск", "оценка риска", "управление рисками", "комплаенс",
    "регуляторные требования", "внутренний контроль"
  ],
  "Отдел комплаенса": [
    "комплаенс", "AML", "KYC", "проверка", "регулятор", "санкции",
    "соответствие", "законодательство"
  ],
  "Отдел казначейства": [
    "казначейство", "ликвидность", "финансы", "денежные потоки",
    "управление активами", "пассивы", "бюджет"
  ],
  "Отдел операционного обслуживания": [
    "операции", "обработка", "документы", "справки", "выписки",
    "очередь", "обслуживание"
  ]
}

const DEPARTMENT_PRIORITY = {
  "Отдел ипотечного кредитования": 10,
  "Отдел карточных продуктов": 9,
  "Отдел кредитования": 8,
  "Отдел депозитов и вкладов": 7,
  "Отдел безопасности": 6,
  "Отдел по работе с проблемной задолженностью": 5,
  "Отдел партнерств и развития бизнеса": 4,
  "Отдел IT и цифровых решений": 3,
  "Отдел претензий и жалоб": 2,
  "Отдел юридических вопросов": 1,
  "Отдел риск-менеджмента": 1,
  "Отдел комплаенса": 1,
  "Отдел казначейства": 1,
  "Отдел валютных операций": 1,
  "Отдел корпоративного обслуживания": 1,
  "Отдел розничного обслуживания": 1,
  "Отдел инвестиционных продуктов": 1,
  "Отдел операционного обслуживания": 0
}

export function detectDepartmentByKeywords(subject, body) {
  const text = (subject + " " + body).toLowerCase()
  const detectedDepartments = {}

  for (const [department, keywords] of Object.entries(BANK_DEPARTMENTS)) {
    for (const keyword of keywords) {
      const regex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i')
      if (regex.test(text)) {
        detectedDepartments[department] = (detectedDepartments[department] || 0) + 1
      }
    }
  }

  if (Object.keys(detectedDepartments).length === 0) {
    return "Отдел операционного обслуживания"
  }

  const sortedDepartments = Object.entries(detectedDepartments).sort(
    (a, b) => {
      if (b[1] !== a[1]) return b[1] - a[1]
      return (DEPARTMENT_PRIORITY[b[0]] || 0) - (DEPARTMENT_PRIORITY[a[0]] || 0)
    }
  )

  return sortedDepartments[0][0]
}

