"""Converts API input into a prompt for AI model."""

from __future__ import annotations

from textwrap import dedent
from typing import List, Dict

from ..models import EmailGenerationRequest, EmailParameters


def _map_length(length: str) -> str:
    return {
        "short": "3-4 предложения",
        "medium": "5-8 предложений",
        "long": "8-12 предложений",
    }[length]


def _render_parameters(params: EmailParameters) -> str:
    directives = [
        f"Тон: {params.tone}",
        f"Цель: {params.purpose}",
        f"Длина: {_map_length(params.length)}",
        f"Аудитория: {params.audience}",
        f"Стиль обращения: {params.address_style}",
        f"Формальные приветствия: {'да' if params.include_formal_greetings else 'нет'}",
        f"Приветствие и заключение: {'включить' if params.include_greeting_and_signoff else 'опустить'}",
        f"Срочность: {params.urgency}",
        f"Корпоративные фразы: {'использовать' if params.include_corporate_phrases else 'избегать'}",
    ]
    if params.extra_directives:
        directives.append("Доп. указания: " + "; ".join(params.extra_directives))
    return "\n".join(f"- {item}" for item in directives)


def _compose_context(req: EmailGenerationRequest, thread_history: str = None, recipient_name: str = None) -> str:
    sections = [f"Постоянный корпоративный контекст:\n{req.company_context.strip()}"]

    # Добавляем историю переписки, если она есть
    if thread_history:
        sections.append(thread_history)

    # Добавляем имя получателя, если оно найдено
    if recipient_name:
        sections.append(f"Имя получателя (адресата письма): {recipient_name}")

    if req.custom_prompt:
        # Убираем дублирование имени получателя, если оно уже есть в custom_prompt
        custom_prompt_text = req.custom_prompt.strip()
        if not custom_prompt_text.startswith("Имя получателя"):
            sections.append(
                "Дополнительное описание задачи:\n" + custom_prompt_text
            )

    sender_lines = []
    if req.sender_first_name:
        sender_lines.append(f"- Имя: {req.sender_first_name}")
    if req.sender_last_name:
        sender_lines.append(f"- Фамилия: {req.sender_last_name}")
    if req.sender_middle_name:
        sender_lines.append(f"- Отчество: {req.sender_middle_name}")
    if req.sender_position:
        sender_lines.append(f"- Должность: {req.sender_position}")
    if req.sender_phone_work:
        sender_lines.append(f"- Рабочий телефон: {req.sender_phone_work}")
    if req.sender_phone_mobile:
        sender_lines.append(f"- Мобильный телефон: {req.sender_phone_mobile}")
    if req.sender_email:
        sender_lines.append(f"- Email: {req.sender_email}")
    if req.sender_address:
        sender_lines.append(f"- Адрес: {req.sender_address}")
    if req.sender_hotline:
        sender_lines.append(f"- Горячая линия: {req.sender_hotline}")
    if req.sender_website:
        sender_lines.append(f"- Сайт: {req.sender_website}")
    if sender_lines:
        sections.append("Данные подписанта:\n" + "\n".join(sender_lines))

    return "\n\n".join(sections)


def build_messages(req: EmailGenerationRequest, department: str = None, thread_history: str = None, recipient_name: str = None) -> List[Dict[str, str]]:
    """Return chat messages array for AI model."""
    params_section = _render_parameters(req.parameters)
    context_block = _compose_context(req, thread_history=thread_history, recipient_name=recipient_name)
    
    prompt = dedent(
        f"""Сгенерируй деловое письмо банка по требованиям ниже.

        Входящее письмо:
        Тема: {req.source_subject}
Текст: {req.source_body}

        {context_block}

Параметры: {params_section}

Правила:
1. СТРОГО соблюдай требуемую длину письма из параметра "Длина". Это КРИТИЧЕСКИ ВАЖНОЕ требование!
   - Если указано "8-12 предложений" → письмо ДОЛЖНО содержать минимум 8 предложений, желательно 10-12. Разверни ответ, добавь детали, объяснения, примеры, дополнительную информацию.
   - Если указано "5-8 предложений" → письмо ОБЯЗАТЕЛЬНО должно содержать от 5 до 8 предложений включительно. НЕ МЕНЬШЕ 5 предложений! Если получилось меньше - добавь детали, разверни мысли, добавь дополнительную информацию.
   - Если указано "3-4 предложения" → письмо должно содержать 3-4 предложения, не больше.
   Для длинных писем используй: детализацию, примеры, объяснение преимуществ, описание процесса, дополнительные предложения, контекст.
   ВАЖНО: При подсчете предложений:
   - НЕ считай точку в датах (например, "28.11.2025", "23.11.2025") за конец предложения. Точки в датах - это разделители чисел, а не знаки препинания.
   - НЕ учитывай подпись (текст после "С уважением,") при подсчете предложений. Подпись добавляется автоматически и не входит в требуемую длину письма.
   - ПЕРЕД отправкой ответа ПРОВЕРЬ количество предложений в основном тексте письма (до подписи). Если предложений меньше требуемого - ДОПОЛНИ письмо до нужного количества.
   Предложение заканчивается только точкой, восклицательным или вопросительным знаком, которые стоят после пробела или в конце абзаца, но НЕ в датах и НЕ в подписи.
2. Переформулируй факты, но не добавляй неподтверждённые данные.
3. На вопросы отвечай пунктами.
4. Если urgency=high, укажи срочность в тексте.
5. Обращение к получателю (кто написал входящее письмо):
   - НЕ используй имя/фамилию ОТПРАВИТЕЛЯ (из "Данные подписанта") в обращении!
   - Если имя получателя указано в блоке "Имя получателя" → используй его в обращении: "Уважаемый [Имя] [Отчество/Фамилия]" или "Уважаемый [Имя]".
   - Если имя получателя НЕ указано → используй только "Уважаемый"/"Уважаемые" без имени.
   - Примеры: "Уважаемый Артем Евгеньевич" (если имя указано), "Уважаемый" (если имя не указано), "Уважаемый коллега" (если audience=colleague и имя не указано).
   - НЕ используй плейсхолдеры "[Имя]" или "[Фамилия]" - используй реальное имя из блока "Имя получателя".
6. НЕ копируй подпись из исходного письма в ответ.
7. Формат ответа:
          Тема: <краткая формулировка>
          Тело:
   <текст письма>
   
   
7. Подпись в конце (обязательно, из "Данные подписанта"):
   - Перед подписью ОБЯЗАТЕЛЬНО добавь ДВЕ пустые строки
   Точный формат подписи (строго соблюдай):
   
          С уважением,
   
   [Фамилия]
   
   [Имя] [Отчество]
   
   
   
   [Должность - разбить на строки по словам "отдела", "управления", "департамента"]
   
   
   
   [Следующая часть должности, если есть]
   
   [Следующая часть должности, если есть]
   
   
   
   [Рабочий телефон]
   
   
   
   [Мобильный телефон]
   
   
   
   [Email]
   
   
   
   [Адрес - разбить на строки: до запятой с "г." на одной строке, остальное на следующей]
   
   
   
   [Горячая линия]
   
   
   
   [Сайт]
   
   Правила форматирования (ОБЯЗАТЕЛЬНО, строго соблюдай):
   - После "С уважением," НЕТ пустой строки (сразу идет фамилия)
   - Фамилия на отдельной строке (будет отформатирована Verdana Bold 12pt)
   - После фамилии НЕТ пустой строки (сразу идет имя)
   - Имя и отчество на следующей строке (одной строкой, будет отформатировано Verdana Bold 12pt)
   - После имени и отчества ДВЕ пустые строки
   - Должность разбить на строки так, чтобы каждое ключевое слово ("отдела", "управления", "департамента") было в конце строки вместе с предыдущим текстом
     Пример: "Начальник отдела медиа продвижения управления маркетинговых коммуникаций департамента маркетинга"
     Должно стать:
     - "Начальник отдела"
     - "медиа продвижения управления"
     - "маркетинговых коммуникаций департамента"
     - "маркетинга"
   - После последней части должности ДВЕ пустые строки
   - Контакты в следующем порядке: рабочий телефон, мобильный телефон, email, адрес, горячая линия, сайт
   - Каждый контакт на отдельной строке
   - Между рабочим телефоном, мобильным телефоном, email и адресом НЕТ пустых строк (идут подряд)
   - Адрес разбить: часть до запятой перед "г." включительно на одной строке (с запятой в конце), остальное на следующей строке
     Пример: "ул. Смирновская, д. 10, стр. 22, г. Москва, Россия, 109052"
     Должно стать:
     - "ул. Смирновская, д. 10, стр. 22,"
     - "г. Москва, Россия, 109052"
   - После адреса (после последней строки адреса) ДВЕ пустые строки
   - После горячей линии НЕТ пустой строки (сразу идет сайт)
   - После сайта добавь одну пустую строку, затем маркер [LOGO] для логотипа банка
   - Если какое-то поле не указано в "Данные подписанта", пропусти его вместе с соответствующими пустыми строками после него
   - Используй ТОЧНО те значения, которые указаны в "Данные подписанта", не меняй их"""
    ).strip()
    return [
        {
            "role": "system",
            "content": (
                "Ты профессиональный автор деловой корреспонденции. "
                "Всегда отвечай на русском языке."
            ),
        },
        {"role": "user", "content": prompt},
    ]

