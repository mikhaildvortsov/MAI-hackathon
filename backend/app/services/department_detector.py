"""Определение отдела банка на основе содержания письма."""

import re
from typing import Literal

# Список основных отделов банка
BankDepartment = Literal[
    "Отдел кредитования",
    "Отдел депозитов и вкладов",
    "Отдел карточных продуктов",
    "Отдел корпоративного обслуживания",
    "Отдел розничного обслуживания",
    "Отдел инвестиционных продуктов",
    "Отдел ипотечного кредитования",
    "Отдел валютных операций",
    "Отдел безопасности",
    "Отдел по работе с проблемной задолженностью",
    "Отдел партнерств и развития бизнеса",
    "Отдел IT и цифровых решений",
    "Отдел претензий и жалоб",
    "Отдел юридических вопросов",
    "Отдел риск-менеджмента",
    "Отдел комплаенса",
    "Отдел казначейства",
    "Отдел операционного обслуживания",
]

# Ключевые слова для определения отделов
DEPARTMENT_KEYWORDS = {
    "Отдел кредитования": [
        "кредит", "займ", "ссуда", "кредитная линия", "овердрафт",
        "кредитная заявка", "кредитный договор", "процентная ставка",
        "погашение кредита", "рефинансирование", "кредитная история"
    ],
    "Отдел депозитов и вкладов": [
        "вклад", "депозит", "накопительный счет", "процент по вкладу",
        "срочный вклад", "до востребования", "капитализация процентов",
        "пополнение вклада", "снятие со вклада"
    ],
    "Отдел карточных продуктов": [
        "карта", "дебетовая карта", "кредитная карта", "бонусы",
        "кэшбэк", "лимит по карте", "блокировка карты", "перевыпуск карты",
        "бесконтактная оплата", "мобильный банк", "интернет-банк"
    ],
    "Отдел корпоративного обслуживания": [
        "расчетный счет", "корпоративный счет", "эквайринг",
        "инкассация", "корпоративная карта", "бизнес-счет",
        "обслуживание юрлиц", "договор банковского обслуживания"
    ],
    "Отдел розничного обслуживания": [
        "физическое лицо", "розничный клиент", "личный счет",
        "перевод", "платеж", "комиссия", "тарифы"
    ],
    "Отдел инвестиционных продуктов": [
        "инвестиции", "брокерский счет", "ценные бумаги", "акции",
        "облигации", "ПИФ", "доверительное управление", "инвестиционный портфель"
    ],
    "Отдел ипотечного кредитования": [
        "ипотека", "ипотечный кредит", "недвижимость", "залог недвижимости",
        "первоначальный взнос", "ипотечная ставка", "досрочное погашение ипотеки"
    ],
    "Отдел валютных операций": [
        "валюта", "обмен валют", "валютный перевод", "курс валют",
        "валютный счет", "конвертация", "валютные операции"
    ],
    "Отдел безопасности": [
        "мошенничество", "безопасность", "блокировка", "подозрительная операция",
        "фишинг", "кража данных", "несанкционированный доступ", "защита"
    ],
    "Отдел по работе с проблемной задолженностью": [
        "просрочка", "задолженность", "долг", "коллекторы",
        "реструктуризация долга", "списание долга", "неплатежеспособность"
    ],
    "Отдел партнерств и развития бизнеса": [
        "партнерство", "сотрудничество", "партнерская программа",
        "B2B", "B2B2C", "интеграция", "API", "белый label"
    ],
    "Отдел IT и цифровых решений": [
        "техническая поддержка", "мобильное приложение", "сайт",
        "API", "интеграция", "технические вопросы", "баг", "ошибка системы"
    ],
    "Отдел претензий и жалоб": [
        "жалоба", "претензия", "недовольство", "возврат средств",
        "компенсация", "нарушение", "некачественное обслуживание"
    ],
    "Отдел юридических вопросов": [
        "юридический вопрос", "договор", "соглашение", "правовые вопросы",
        "регулирование", "лицензия", "соответствие требованиям"
    ],
    "Отдел риск-менеджмента": [
        "риски", "риск-менеджмент", "кредитный риск", "операционный риск",
        "ликвидность", "стресс-тестирование"
    ],
    "Отдел комплаенса": [
        "комплаенс", "соответствие", "регуляторные требования",
        "AML", "KYC", "противодействие отмыванию", "санкции"
    ],
    "Отдел казначейства": [
        "казначейство", "ликвидность", "управление активами",
        "процентный риск", "валютный риск"
    ],
    "Отдел операционного обслуживания": [
        "операции", "обработка платежей", "клиринг", "расчеты",
        "банковские операции", "документооборот"
    ],
}


# Веса для ключевых слов отделов
DEPARTMENT_KEYWORD_WEIGHTS = {
    "Отдел ипотечного кредитования": {
        "ипотека": 3.0,
        "ипотечный кредит": 4.0,
        "недвижимость": 2.5,
        "жилье": 2.0,
        "квартира": 2.0,
        "дом": 1.5,
        "ипотечная программа": 3.5,
        "льготный период": 2.0,
    },
    "Отдел кредитования": {
        "кредит": 2.0,
        "кредитная заявка": 3.5,
        "кредитный договор": 3.0,
        "процентная ставка": 2.5,
        "погашение кредита": 2.5,
        "рефинансирование": 3.0,
        "кредитная история": 2.0,
        "просроченная задолженность": 3.5,
        "просрочка": 2.5,
    },
    "Отдел карточных продуктов": {
        "карта": 2.5,
        "дебетовая карта": 3.5,
        "кредитная карта": 3.5,
        "блокировка карты": 3.0,
        "перевыпуск карты": 3.0,
        "кэшбэк": 2.0,
        "бонусы": 1.5,
    },
    "Отдел депозитов и вкладов": {
        "вклад": 3.0,
        "депозит": 3.0,
        "процент по вкладу": 3.5,
        "накопительный счет": 2.5,
        "капитализация процентов": 2.5,
    },
    "Отдел безопасности": {
        "мошенничество": 4.0,
        "безопасность": 2.5,
        "подозрительная операция": 4.0,
        "фишинг": 3.5,
        "кража данных": 4.0,
        "несанкционированный доступ": 4.0,
    },
    "Отдел претензий и жалоб": {
        "жалоба": 4.0,
        "претензия": 4.0,
        "недовольство": 3.5,
        "возврат средств": 3.5,
        "компенсация": 3.0,
    },
    "Отдел партнерств и развития бизнеса": {
        "партнерство": 3.5,
        "сотрудничество": 3.0,
        "партнерская программа": 4.0,
        "b2b": 2.5,
        "интеграция": 2.0,
    },
    "Отдел IT и цифровых решений": {
        "техническая поддержка": 3.5,
        "мобильное приложение": 3.0,
        "сайт": 2.0,
        "api": 2.5,
        "баг": 2.5,
        "ошибка системы": 3.0,
    },
    "Отдел корпоративного обслуживания": {
        "юридическое лицо": 3.5,
        "корпоративный клиент": 3.0,
        "бизнес-счет": 3.0,
        "расчетно-кассовое обслуживание": 3.5,
    },
    "Отдел операционного обслуживания": {
        "операции": 1.0,
        "обработка": 1.0,
        "документы": 1.0,
    },
}


def calculate_department_score(text: str, department: str) -> float:
    """Вычисляет взвешенный score для отдела."""
    text_lower = text.lower()
    score = 0.0
    
    # Используем веса, если они есть
    if department in DEPARTMENT_KEYWORD_WEIGHTS:
        weights = DEPARTMENT_KEYWORD_WEIGHTS[department]
        for keyword, weight in weights.items():
            pattern = r'\b' + re.escape(keyword.lower()) + r'\b'
            matches = len(re.findall(pattern, text_lower, re.IGNORECASE))
            score += matches * weight
    else:
        # Fallback на старый метод для отделов без весов
        keywords = DEPARTMENT_KEYWORDS.get(department, [])
        for keyword in keywords:
            pattern = r'\b' + re.escape(keyword.lower()) + r'\b'
            if re.search(pattern, text_lower, re.IGNORECASE):
                score += 1.0
    
    return score


def detect_department_by_keywords(subject: str, body: str) -> str:
    """
    Определяет отдел банка на основе взвешенных ключевых слов в теме и тексте письма.
    Использует систему весов для более точного определения.
    """
    text = f"{subject} {body}".lower()
    
    department_scores = {}
    
    # Приоритетные отделы (получают бонус к score)
    priority_departments = [
        "Отдел ипотечного кредитования",
        "Отдел карточных продуктов",
        "Отдел инвестиционных продуктов",
        "Отдел безопасности",
        "Отдел претензий и жалоб",
    ]
    
    # Вычисляем score для всех отделов
    for department in DEPARTMENT_KEYWORDS.keys():
        score = calculate_department_score(text, department)
        
        # Бонус для приоритетных отделов
        if department in priority_departments and score > 0:
            score *= 1.5
        
        if score > 0:
            department_scores[department] = score
    
    if department_scores:
        # Возвращаем отдел с наибольшим score
        return max(department_scores.items(), key=lambda x: x[1])[0]
    
    # Если не найдено совпадений, возвращаем отдел операционного обслуживания
    return "Отдел операционного обслуживания"


def get_department_instruction(department: str) -> str:
    """Возвращает инструкцию для добавления в промпт о направлении в отдел."""
    return (
        f"\n- В самом конце письма, после подписи, добавь строку: "
        f'"Направить в {department}"'
    )

