"""Определение отдела банка на основе содержания письма."""

from typing import Literal

# Список основных отделов банка
BankDepartment = Literal[
    "Отдел кредитования",
    "Отдел депозитов и вкладов",
    "Отдел карточных продуктов",
    "Отдел корпоративного обслуживания",
    "Отдел розничного обслуживания",
    "Отдел инвестиционных продуктов",
    "Отдел ипотечного кредитования",
    "Отдел валютных операций",
    "Отдел безопасности",
    "Отдел по работе с проблемной задолженностью",
    "Отдел партнерств и развития бизнеса",
    "Отдел IT и цифровых решений",
    "Отдел претензий и жалоб",
    "Отдел юридических вопросов",
    "Отдел риск-менеджмента",
    "Отдел комплаенса",
    "Отдел казначейства",
    "Отдел операционного обслуживания",
]

# Ключевые слова для определения отделов
DEPARTMENT_KEYWORDS = {
    "Отдел кредитования": [
        "кредит", "займ", "ссуда", "кредитная линия", "овердрафт",
        "кредитная заявка", "кредитный договор", "процентная ставка",
        "погашение кредита", "рефинансирование", "кредитная история"
    ],
    "Отдел депозитов и вкладов": [
        "вклад", "депозит", "накопительный счет", "процент по вкладу",
        "срочный вклад", "до востребования", "капитализация процентов",
        "пополнение вклада", "снятие со вклада"
    ],
    "Отдел карточных продуктов": [
        "карта", "дебетовая карта", "кредитная карта", "бонусы",
        "кэшбэк", "лимит по карте", "блокировка карты", "перевыпуск карты",
        "бесконтактная оплата", "мобильный банк", "интернет-банк"
    ],
    "Отдел корпоративного обслуживания": [
        "расчетный счет", "корпоративный счет", "эквайринг",
        "инкассация", "корпоративная карта", "бизнес-счет",
        "обслуживание юрлиц", "договор банковского обслуживания"
    ],
    "Отдел розничного обслуживания": [
        "физическое лицо", "розничный клиент", "личный счет",
        "перевод", "платеж", "комиссия", "тарифы"
    ],
    "Отдел инвестиционных продуктов": [
        "инвестиции", "брокерский счет", "ценные бумаги", "акции",
        "облигации", "ПИФ", "доверительное управление", "инвестиционный портфель"
    ],
    "Отдел ипотечного кредитования": [
        "ипотека", "ипотечный кредит", "недвижимость", "залог недвижимости",
        "первоначальный взнос", "ипотечная ставка", "досрочное погашение ипотеки"
    ],
    "Отдел валютных операций": [
        "валюта", "обмен валют", "валютный перевод", "курс валют",
        "валютный счет", "конвертация", "валютные операции"
    ],
    "Отдел безопасности": [
        "мошенничество", "безопасность", "блокировка", "подозрительная операция",
        "фишинг", "кража данных", "несанкционированный доступ", "защита"
    ],
    "Отдел по работе с проблемной задолженностью": [
        "просрочка", "задолженность", "долг", "коллекторы",
        "реструктуризация долга", "списание долга", "неплатежеспособность"
    ],
    "Отдел партнерств и развития бизнеса": [
        "партнерство", "сотрудничество", "партнерская программа",
        "B2B", "B2B2C", "интеграция", "API", "белый label"
    ],
    "Отдел IT и цифровых решений": [
        "техническая поддержка", "мобильное приложение", "сайт",
        "API", "интеграция", "технические вопросы", "баг", "ошибка системы"
    ],
    "Отдел претензий и жалоб": [
        "жалоба", "претензия", "недовольство", "возврат средств",
        "компенсация", "нарушение", "некачественное обслуживание"
    ],
    "Отдел юридических вопросов": [
        "юридический вопрос", "договор", "соглашение", "правовые вопросы",
        "регулирование", "лицензия", "соответствие требованиям"
    ],
    "Отдел риск-менеджмента": [
        "риски", "риск-менеджмент", "кредитный риск", "операционный риск",
        "ликвидность", "стресс-тестирование"
    ],
    "Отдел комплаенса": [
        "комплаенс", "соответствие", "регуляторные требования",
        "AML", "KYC", "противодействие отмыванию", "санкции"
    ],
    "Отдел казначейства": [
        "казначейство", "ликвидность", "управление активами",
        "процентный риск", "валютный риск"
    ],
    "Отдел операционного обслуживания": [
        "операции", "обработка платежей", "клиринг", "расчеты",
        "банковские операции", "документооборот"
    ],
}


def detect_department_by_keywords(subject: str, body: str) -> str:
    """
    Определяет отдел банка на основе ключевых слов в теме и тексте письма.
    Возвращает отдел с наибольшим количеством совпадений.
    Использует приоритеты для более специфичных отделов (например, ипотека > кредит).
    """
    text = f"{subject} {body}".lower()
    
    department_scores = {}
    
    # Приоритетные отделы (проверяются первыми для более точного определения)
    priority_departments = [
        "Отдел ипотечного кредитования",
        "Отдел карточных продуктов",
        "Отдел инвестиционных продуктов",
        "Отдел безопасности",
        "Отдел претензий и жалоб",
    ]
    
    # Сначала проверяем приоритетные отделы
    for department in priority_departments:
        if department in DEPARTMENT_KEYWORDS:
            keywords = DEPARTMENT_KEYWORDS[department]
            score = sum(1 for keyword in keywords if keyword.lower() in text)
            if score > 0:
                department_scores[department] = score * 2  # Увеличиваем вес приоритетных отделов
    
    # Затем проверяем остальные отделы
    for department, keywords in DEPARTMENT_KEYWORDS.items():
        if department not in priority_departments:
            score = sum(1 for keyword in keywords if keyword.lower() in text)
            if score > 0:
                # Если отдел уже есть в scores, берем максимум
                if department in department_scores:
                    department_scores[department] = max(department_scores[department], score)
                else:
                    department_scores[department] = score
    
    if department_scores:
        # Возвращаем отдел с наибольшим количеством совпадений
        return max(department_scores.items(), key=lambda x: x[1])[0]
    
    # Если не найдено совпадений, возвращаем отдел операционного обслуживания
    return "Отдел операционного обслуживания"


def get_department_instruction(department: str) -> str:
    """Возвращает инструкцию для добавления в промпт о направлении в отдел."""
    return (
        f"\n- В самом конце письма, после подписи, добавь строку: "
        f'"Направить в {department}"'
    )

